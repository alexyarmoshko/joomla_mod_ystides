# YSTides Module Plan

## Context & Clarifications

- Data source: ERDDAP IMI-TidePrediction via CSV with explicit columns and filters only on `stationID` and date range (current date through current date + DaysRange inclusive). Columns used now: `time`, `stationID`, `longitude`, `latitude`, `Water_Level`, `Water_Level_ODM`. `TideCoefficient` will be added later. StationName comes from the ERDDAP dropdown list.
- Caching: SQLite path configurable, default `/cache/ystides` relative to Joomla root; module will create missing folders/files. No historical backfill beyond configured forward window.
- Display: Times shown in UTC. Use simple HTML symbols (▲/▼) for high/low markers. Equal successive water-level values keep the same category as the previous point.

## Phased Approach

1) **Scaffold module - Completed**: Create manifest, services/dispatcher, helper/model, default layout, and language strings. Add params for StationID dropdown (populated from ERDDAP station list, also used to seed TideStations), DaysRange (default 7), and SQLite path. Render basic table shell using configured values.
2) **SQLite data layer - Completed**: Build helper to open/create DB at configured path, ensure directory creation under `/cache/ystides`, and create tables `TideStations` and `TideData` per schema with keys/indices. Seed TideStations using the ERDDAP station dropdown data (StationID, StationName, coords).
3) **Fetch & cache - Completed**: Request ERDDAP CSV selecting only needed columns for the chosen station and date window (inclusive today → today+DaysRange), ordered by time. Stream-parse to minimize memory, cast types, insert missing TideData rows, and upsert station metadata (Lon/Lat). Leave `TideCoefficient` placeholder for later.
4) **Categorization - Completed**: For each day, mark highest WLM as `h` and lowest as `l`. For other rows, compare to previous value: rising → `f`, falling → `e`; equal successive values keep the prior category. Apply deterministic handling for ties within the day.
5) **Render output - Completed**: Load cached data for the station/date window; format date/time with Joomla helpers in UTC. Show table with StationName header, date range row, then time/WLM/triangle marker rows. Add minimal CSS/JS via asset manager; all labels via language strings.
6) **Refactoring and improvements - Completed**: Using moon phases API for one year at <https://aa.usno.navy.mil/data/api> (<https://aa.usno.navy.mil/api/moon/phases/year?year=YEAR>) create an additional helpers to retrieve the phases data for a year or years for which tide is shown and cache the data in a new table TideMoonPhases with a fields "PhaseDT" TEXT NOT NULL PRIMARY KEY, "Phase" TEXT NOT NULL. Phases values for this table are mapped to "new", "1q", "full", "2q". Data to be retrieved from API only if it does not exist in the cache table. Data is regarded to exist if any records of a particular year exists.
7) **Add a feature - Weather warnings**: Add a feature to show weather warnings for the tide location/date. The data source/API to use is <https://www.met.ie/warningsxml/rss.xml> (Atom feed). The location codes are listed in ./MET_IE_FIPS_EMMA_ID.json file. The samples of the XML feed data are also available in the docs folder. There should be a cached table (WeatherWarnings) for information retrieved from the API based on the fields available in the feed. Before fetching the data itself a HEAD request should be made to check if the data is up to date. If the data is up to date, it should be retrieved from the cache. The "Last-Modified" HTTP header should be used and cached to determine if the cached data is up to date or must be refreshed. There should be a "RETRIEVED_AT" field in the table to store the last retrieval time. The data with the most up to date "RETRIEVED_AT" should be used to display the warnings. The warning should be present as an icon in the appropriate row of the table (once per day, right after the date). Icon with the highest severity level should be shown in the appropriate row of the table. If the nation wide warning is present the similar icon should be shown in the module header (beside the station name). The highest severity level should be used to determine the icon to show. Any warning icon should have a link that opens <https://www.met.ie/warnings-today.html> in a new window/tab. Right now only the marine related warnings should be shown. There are a set of icons available for warnings in media/images folder.
8) **Admin UX & tests**: Validate params (filters, path handling), add helpful logging/errors. Where feasible, add unit/feature tests for CSV parsing and categorization logic. Confirm CSRF handling for any actions beyond display.
